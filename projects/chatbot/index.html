<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Memory-Safe Local AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#0d1117] text-gray-300 min-h-screen p-6 flex flex-col items-center">

    <div class="w-full max-w-2xl bg-[#161b22] border border-gray-800 rounded-xl flex flex-col h-[80vh]">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center">
            <h2 class="font-bold text-blue-400 text-sm tracking-widest">LOCAL_CORE_V3</h2>
            <span id="status" class="text-[10px] bg-red-900/30 text-red-400 px-2 py-1 rounded">OFFLINE</span>
        </div>

        <div id="chat" class="flex-1 overflow-y-auto p-4 space-y-4 text-sm"></div>

        <div class="p-4 border-t border-gray-800 bg-[#0d1117]">
            <div class="flex gap-2">
                <input type="text" id="input" placeholder="Type message..." class="flex-1 bg-transparent border border-gray-700 rounded px-3 py-2 outline-none focus:border-blue-500 text-sm">
                <button id="send" disabled class="bg-blue-600 hover:bg-blue-500 disabled:bg-gray-800 px-4 py-2 rounded text-xs font-bold transition-all">SEND</button>
            </div>
        </div>
    </div>

    <script type="module">
        const worker = new Worker('worker.js', { type: 'module' });
        const chat = document.getElementById('chat');
        const input = document.getElementById('input');
        const btn = document.getElementById('send');
        const status = document.getElementById('status');

        let currentResponseDiv = null;

        // Start loading immediately
        worker.postMessage({ type: 'load' });
        status.innerText = "INITIALIZING GPU...";

        worker.onmessage = (e) => {
            const { type, output, error } = e.data;

            if (type === 'ready') {
                status.innerText = "ONLINE (WEBGPU)";
                status.className = "text-[10px] bg-green-900/30 text-green-400 px-2 py-1 rounded";
                btn.disabled = false;
            }

            if (type === 'update') {
                currentResponseDiv.innerText = output;
                chat.scrollTop = chat.scrollHeight;
            }

            if (type === 'done') {
                btn.disabled = false;
            }

            if (type === 'error') {
                status.innerText = "MEMORY ERROR - RESTART BROWSER";
                alert("Out of Memory: " + error);
            }
        };

        btn.onclick = () => {
            const text = input.value;
            if (!text) return;
            
            appendMsg("USER", text, "text-blue-400");
            currentResponseDiv = appendMsg("AI", "...", "text-green-400");
            
            worker.postMessage({ type: 'generate', text });
            input.value = '';
            btn.disabled = true;
        };

        function appendMsg(who, text, color) {
            const d = document.createElement('div');
            d.innerHTML = `<div class="font-bold ${color} text-[10px] mb-1">${who}</div><div class="bg-gray-800/50 p-2 rounded">${text}</div>`;
            chat.appendChild(d);
            chat.scrollTop = chat.scrollHeight;
            return d.lastChild;
        }
    </script>
</body>
</html>
